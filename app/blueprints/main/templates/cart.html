{% extends 'base.html' %}
{% block title %}Your Cart - Sam's Nik Naks{% endblock %}

{# ---------- On-page macros ---------- #}
{% macro currency(amount) -%}
${{ '%.2f'|format(amount or 0) }}
{%- endmacro %}

{% macro line_item(item) -%}
  {% set image = item.image or 'img/prod1.jpg' %}
  {% set qty = item.qty or 1 %}
  {% set unit = item.price or 0 %}
  {% set line_total = (unit * qty) %}
  <li class="rounded-2xl bg-white shadow-card p-4">
    <div class="flex items-start gap-4">
      <a href="{{ url_for('main.product', slug=item.slug) if item.slug else '#' }}" class="shrink-0 block w-28 h-28 rounded-xl overflow-hidden bg-slate-100">
        <img src="{{ url_for('static', filename=image) }}" alt="{{ item.name }}" class="w-full h-full object-cover">
      </a>
      <div class="flex-1">
        <div class="flex items-start justify-between gap-4">
          <div>
            <a href="{{ url_for('main.product', slug=item.slug) if item.slug else '#' }}" class="font-semibold hover:underline">{{ item.name }}</a>
            {% if item.variant %}
            <div class="mt-1 text-sm text-slate-600">{{ item.variant }}</div>
            {% endif %}
          </div>
          <div class="text-right">
            <div class="font-semibold">{{ currency(unit) }}</div>
            <div class="text-sm text-slate-600">ea</div>
          </div>
        </div>
        <div class="mt-3 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="text-sm text-slate-600">Qty</div>
            <div class="inline-flex items-center rounded-lg border border-slate-300">
              <button type="button" class="px-2 py-1 hover:bg-slate-50" aria-label="Decrease quantity" data-cart-decrement="{{ item.id }}">−</button>
              <input type="number" min="1" value="{{ qty }}" class="w-14 text-center py-1 border-x border-slate-300" data-cart-qty="{{ item.id }}">
              <button type="button" class="px-2 py-1 hover:bg-slate-50" aria-label="Increase quantity" data-cart-increment="{{ item.id }}">+</button>
            </div>
            <button type="button" class="ml-3 text-sm text-slate-600 hover:text-slate-900" data-cart-remove="{{ item.id }}">Remove</button>
          </div>
          <div class="font-semibold">{{ currency(line_total) }}</div>
        </div>
      </div>
    </div>
  </li>
{%- endmacro %}

{% macro summary_row(label, value, emphasize=False) -%}
  <div class="flex items-center justify-between">
    <div class="text-slate-600 {% if emphasize %}font-semibold text-slate-800{% endif %}">{{ label }}</div>
    <div class="{% if emphasize %}font-bold text-slate-900 text-lg{% else %}text-slate-800{% endif %}">{{ value }}</div>
  </div>
{%- endmacro %}

{% block content %}

<!-- Hero -->
<section class="relative bg-gradient-to-b from-slate-900 to-slate-800 text-white py-16">
  <div class="mx-auto max-w-7xl px-6 lg:px-8">
    <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">Your Cart</h1>
    <p class="mt-3 text-slate-200">Review items and proceed to secure checkout.</p>
  </div>
</section>

{# Sample fallback data if cart is not provided #}
{% set sample_items = [
  {'id': 1, 'slug': 'sticker-pack', 'name': 'Sticker Pack', 'variant': '5 pack', 'image': 'img/prod1.jpg', 'price': 9.99, 'qty': 2},
  {'id': 2, 'slug': 'tray', 'name': 'Serving Tray', 'variant': 'Walnut', 'image': 'img/prod2.jpg', 'price': 48.00, 'qty': 1},
  {'id': 3, 'slug': 'ashtray', 'name': 'Resin Ashtray', 'variant': 'Smoke', 'image': 'img/prod3.jpg', 'price': 22.50, 'qty': 1}
] %}

{% set items = (cart.items if cart and (cart.items is defined) and cart.items else sample_items) %}

{% set ns = namespace(subtotal=0) %}
{% for i in items %}
  {% set ns.subtotal = ns.subtotal + ((i.price or 0) * (i.qty or 1)) %}
{% endfor %}
{% set subtotal = (cart.subtotal if cart and (cart.subtotal is defined) else ns.subtotal) %}
{% set shipping = (cart.shipping if cart and (cart.shipping is defined) else 5.00) %}
{% set tax = (cart.tax if cart and (cart.tax is defined) else (subtotal * 0.06)) %}
{% set discount = (cart.discount if cart and (cart.discount is defined) else 0.00) %}
{% set total = (cart.total if cart and (cart.total is defined) else (subtotal + shipping + tax - discount)) %}

<!-- Layout -->
<section class="py-16 bg-white">
  <div class="mx-auto max-w-7xl px-6 lg:px-8 grid gap-10 lg:grid-cols-3">

    <!-- Items -->
    <div class="lg:col-span-2">
      {% if items and items|length > 0 %}
      <ul class="grid gap-4">
        {% for item in items %}
          {{ line_item(item) }}
        {% endfor %}
      </ul>
      <div class="mt-6">
        <a href="{{ url_for('main.shop') }}" class="text-sm text-slate-700 hover:underline">← Continue shopping</a>
      </div>
      {% else %}
      <div class="text-center py-24">
        <h3 class="text-2xl font-semibold">Your cart is empty</h3>
        <p class="mt-2 text-slate-600">Find something you love in the shop.</p>
        <a href="{{ url_for('main.shop') }}" class="mt-6 inline-block rounded-xl bg-brand-600 px-6 py-3 text-white hover:bg-brand-700">Browse Products</a>
      </div>
      {% endif %}
    </div>

    <!-- Summary -->
    <aside class="lg:col-span-1">
      <div class="rounded-2xl bg-white shadow-card p-6">
        <h2 class="text-lg font-semibold">Order Summary</h2>
        <div class="mt-4 grid gap-3">
          {{ summary_row('Subtotal', currency(subtotal)) }}
          {{ summary_row('Shipping', 'Free' if shipping == 0 else currency(shipping)) }}
          {{ summary_row('Estimated tax', currency(tax)) }}
          {% if discount and discount > 0 %}
            {{ summary_row('Discount', '-' ~ currency(discount)) }}
          {% endif %}
          <div class="border-t border-slate-200 my-2"></div>
          {{ summary_row('Total', currency(total), True) }}
        </div>

        <!-- Coupon -->
        <form class="mt-6 grid grid-cols-[1fr_auto] gap-3" method="post" action="#">
          <input name="coupon" placeholder="Coupon code" class="rounded-lg border border-slate-300 px-3 py-2" />
          <button class="rounded-lg border border-slate-300 px-4 py-2 hover:bg-slate-50">Apply</button>
        </form>

        <!-- Checkout CTA -->
        <a href="{{ url_for('main.checkout') }}" class="mt-6 block text-center rounded-xl bg-slate-900 px-6 py-3 text-white hover:bg-slate-800">Checkout</a>
        <p class="mt-2 text-xs text-slate-500">By placing your order, you agree to our <a href="{{ url_for('main.returns') }}" class="hover:underline">Return Policy</a>.</p>
      </div>
    </aside>

  </div>
</section>

{% endblock %}
